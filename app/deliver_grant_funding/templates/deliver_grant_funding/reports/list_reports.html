{% extends "deliver_grant_funding/grant_base.html" %}
{% from "govuk_frontend_jinja/components/button/macro.html" import govukButton %}
{% from "govuk_frontend_jinja/components/summary-list/macro.html" import govukSummaryList %}
{% from "govuk_frontend_jinja/components/notification-banner/macro.html" import govukNotificationBanner %}
{% from "common/macros/status.html" import reportStatusTag with context %}
{% from "common/macros/status.html" import grantStatusTag with context %}
{% from "common/macros/status.html" import grantStatusDescription with context %}

{% set page_title = "Reports" %}
{% set active_item_identifier = "reports" %}
{% set grant_admin = authorisation_helper.is_deliver_grant_admin(grant.id, current_user) %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      {# TODO: FSPT-549 - show flash messages consistently everywhere with a standard interface #}
      {% with flashes = get_flashed_messages(with_categories=true) %}
        {% for flash in flashes %}
          {{ govukNotificationBanner({ "text": flash[1], "type": flash[0] }) }}
        {% endfor %}
      {% endwith %}

      {% if delete_form %}
        {% set banner_html %}
          <p class="govuk-body govuk-!-font-weight-bold">Are you sure you want to delete the report ‘{{ delete_report.name }}’?</p>
          <form method="post" novalidate>
            {{ delete_form.csrf_token }}
            <div class="govuk-button-group govuk-!-margin-bottom-0">
              {{ delete_form.confirm_deletion(params={"text": "Yes, delete this report", "classes": "govuk-button--secondary govuk-!-margin-bottom-0"}) }}
              <a class="govuk-link govuk-link--no-visited-state govuk-!-margin-bottom-0" href="{{ url_for('deliver_grant_funding.list_reports', grant_id=grant.id) }}">Cancel</a>
            </div>
          </form>
        {% endset %}

        {{ govukNotificationBanner(params={"role": "alert", "titleText": "Important", "html": banner_html}) }}
      {% endif %}

      <h1 class="govuk-heading-l">
        <span class="govuk-caption-l">{{ grant.name }}</span>
        Reports
      </h1>

      <p class="govuk-body"><strong>Grant status</strong>: {{ grantStatusTag(grant.status) }}</p>
      <p class="govuk-body">{{ grantStatusDescription(grant) }}</p>
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      {% if not grant.reports %}
        <p class="govuk-body">There are no monitoring reports for {{ grant.name }}.</p>
      {% else %}
        {% for report in grant.reports %}
          {% set can_edit = authorisation_helper.can_edit_collection(current_user, report.id) %}
          {% set formSectionsText %}
            {% if can_edit %}
              {% if report.forms | length == 0 %}
                <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.add_section', grant_id=grant.id, report_id=report.id) }}"
                  >Add sections<span class="govuk-visually-hidden"> to {{ report.name }}</span></a
                >
                to create your report
                <br />
                Sections are groups of questions with a common theme
              {% else %}
                <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.list_report_sections', grant_id=grant.id, report_id=report.id) }}">
                  {{ report.forms | length }} sections<span class="govuk-visually-hidden"> in report for {{ report.name }}</span>
                </a>
              {% endif %}
            {% else %}
              <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.list_report_sections', grant_id=grant.id, report_id=report.id) }}">
                {{ report.forms | length }} sections<span class="govuk-visually-hidden"> in report for {{ report.name }}</span>
              </a>
            {% endif %}
          {% endset %}


          {% set liveSubmissionsText %}
            {% trans count=report.live_submissions | length %}{{ count }} live submission{% pluralize %}{{ count }} live submissions{% endtrans %} <span class="govuk-visually-hidden">for {{ report.name }}</span>
          {% endset %}
          {% set testSubmissionsText %}
            {% trans count=report.test_submissions | length %}{{ count }} test submission{% pluralize %}{{ count }} test submissions{% endtrans %} <span class="govuk-visually-hidden">for {{ report.name }}</span>
          {% endset %}


          {% set submissionsHtml %}
            <p class="govuk-body">
              <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.list_submissions', grant_id=grant.id, report_id=report.id, submission_mode=enum.submission_mode.LIVE) }}">
                {{ liveSubmissionsText }}
              </a>
            </p>

            {# TODO: hide test submissions link when the reporting round status is live #}
            <p class="govuk-body">
              <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.list_submissions', grant_id=grant.id, report_id=report.id, submission_mode=enum.submission_mode.TEST) }}">
                {{ testSubmissionsText }}
              </a>
            </p>
          {% endset %}


          {% set reportingPeriodText %}
            {% if report.reporting_period_start_date and report.reporting_period_end_date %}
              {{ format_date_range(report.reporting_period_start_date, report.reporting_period_end_date) }}
            {% else %}
              Not set
            {% endif %}
          {% endset %}


          {% set submissionPeriodText %}
            {% if report.submission_period_start_date and report.submission_period_end_date %}
              {{ format_date_range(report.submission_period_start_date, report.submission_period_end_date) }}
            {% else %}
              Not set
            {% endif %}
          {% endset %}

          {% set actions = [] %}
          {% if can_edit %}
            {% do actions.append({"text": "Change name", "visuallyHiddenText": report.title, "href": url_for("deliver_grant_funding.change_report_name", grant_id=grant.id, report_id=report.id), "classes": "govuk-link--no-visited-state" }) %}
            {% if not report.live_submissions %}
              {% do actions.append({"text": "Delete", "visuallyHiddenText": report.title, "href": url_for("deliver_grant_funding.list_reports", grant_id=grant.id, delete=report.id), "classes": "govuk-link--no-visited-state" }) %}
            {% endif %}
          {% endif %}

          {{
            govukSummaryList({
            	"card": {
            		"title": {"text": report.name},
            		"actions": {
            			"items": actions,
            		},
            	},
            	"rows": [
            	  {
            	    "key": {"text": "Report status"},
            	    "value": {"html": reportStatusTag(report.status)},
            	  },
            		{
            			"key": {"text": "Form"},
            			"value": {"text": formSectionsText},
            		},
            		{"key": {"text": "Reporting period"}, "value": {"text": reportingPeriodText} },
            		{"key": {"text": "Submission period"}, "value": {"text": submissionPeriodText} },
            		{"key": {"text": "Submissions"}, "value": {"html": submissionsHtml} },
            		{"key": {"text": "Created by"}, "value": {"text": report.created_by.email} },
            	],
            })
          }}
        {% endfor %}
      {% endif %}

      {% if grant_admin %}
        {{
          govukButton({
            "text": "Add a monitoring report" if not grant.reports else "Add another monitoring report",
            "classes": "" if not grant.reports else "govuk-button--secondary",
            "href": url_for('deliver_grant_funding.set_up_report', grant_id=grant.id)
          })
        }}
      {% endif %}
    </div>
  </div>
{% endblock content %}
