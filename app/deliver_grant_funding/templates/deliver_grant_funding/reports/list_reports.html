{% extends "deliver_grant_funding/grant_base.html" %}
{% from "govuk_frontend_jinja/components/button/macro.html" import govukButton %}
{% from "govuk_frontend_jinja/components/summary-list/macro.html" import govukSummaryList %}

{% set page_title = "Reports" %}
{% set active_item_identifier = "reports" %}
{% set grant_admin = authorisation_helper.is_grant_admin(grant.id, current_user) %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h1 class="govuk-heading-l">
        <span class="govuk-caption-l">{{ grant.name }}</span>
        Reports
      </h1>
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      {% if not grant.collections %}
        <p class="govuk-body">This grant has no monitoring reports.</p>
      {% else %}
        {# TODO: Add a `reports` property to the grant which filters this down based on a (to be added) CollectionType enum #}
        {% for report in grant.collections %}
          {% set formSectionsAndTasksText %}
            {% if grant_admin %}
              {% if report.forms | length == 0 %}
                <a class="govuk-link govuk-link--no-visited-state" href="#">Add tasks<span class="govuk-visually-hidden"> to {{ report.name }}</span></a>
                to create your report
                <br />
                Tasks are groups of questions with a common theme
              {% else %}
                <a class="govuk-link govuk-link--no-visited-state" href="#">{{ report.tasks | length }} tasks<span class="govuk-visually-hidden"> in report for {{ report.name }}</span></a>
              {% endif %}
            {% else %}
              <a class="govuk-link govuk-link--no-visited-state" href="#">{{ report.tasks | length }} tasks<span class="govuk-visually-hidden"> in report for {{ report.name }}</span></a>
            {% endif %}
          {% endset %}

          {{
            govukSummaryList({
            	"card": {
            		"title": {"text": report.name},
            		"actions": {
            			"items": [
            				{"text": "Manage", "visuallyHiddenText": report.title, "href": "#", "classes": "govuk-link--no-visited-state" },
            			] if grant_admin else [],
            		},
            	},
            	"rows": [
            		{
            			"key": {"text": "Report"},
            			"value": {"text": formSectionsAndTasksText},
            		},
            		{"key": {"text": "Created by"}, "value": {"text": report.created_by.email} },
            		{"key": {"text": "Last updated"}, "value": {"text": format_date(report.updated_at_utc)} },
            	],
            })
          }}
        {% endfor %}
      {% endif %}

      {% if grant_admin %}
        {{
          govukButton({
            "text": "Add a monitoring report" if not grant.collections else "Add another monitoring report",
            "classes": "" if not grant.collections else "govuk-button--secondary",
            "href": "#"
          })
        }}
      {% endif %}
    </div>
  </div>
{% endblock content %}
