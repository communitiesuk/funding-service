{% extends "deliver_grant_funding/grant_base.html" %}
{% from "govuk_frontend_jinja/components/button/macro.html" import govukButton %}
{% from "govuk_frontend_jinja/components/summary-list/macro.html" import govukSummaryList %}
{% from "govuk_frontend_jinja/components/notification-banner/macro.html" import govukNotificationBanner %}

{% set page_title = "Reports" %}
{% set active_item_identifier = "reports" %}
{% set grant_admin = authorisation_helper.is_deliver_grant_admin(grant.id, current_user) %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      {% if delete_form %}
        {% set banner_html %}
          <p class="govuk-body govuk-!-font-weight-bold">Are you sure you want to delete the report ‘{{ delete_report.name }}’?</p>
          <form method="post" novalidate>
            {{ delete_form.csrf_token }}
            <div class="govuk-button-group govuk-!-margin-bottom-0">
              {{ delete_form.confirm_deletion(params={"text": "Yes, delete this report", "classes": "govuk-button--secondary govuk-!-margin-bottom-0"}) }}
              <a class="govuk-link govuk-link--no-visited-state govuk-!-margin-bottom-0" href="{{ url_for('deliver_grant_funding.list_reports', grant_id=grant.id) }}">Cancel</a>
            </div>
          </form>
        {% endset %}

        {{ govukNotificationBanner(params={"role": "alert", "titleText": "Important", "html": banner_html}) }}
      {% endif %}

      <h1 class="govuk-heading-l">
        <span class="govuk-caption-l">{{ grant.name }}</span>
        Reports
      </h1>
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      {% if not grant.reports %}
        <p class="govuk-body">There are no monitoring reports for {{ grant.name }}.</p>
      {% else %}
        {% for report in grant.reports %}
          {% set formSectionsAndTasksText %}
            {% if grant_admin %}
              {% if report.forms | length == 0 %}
                <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.add_task', grant_id=grant.id, report_id=report.id) }}">Add tasks<span class="govuk-visually-hidden"> to {{ report.name }}</span></a>
                to create your report
                <br />
                Tasks are groups of questions with a common theme
              {% else %}
                <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.list_report_tasks', grant_id=grant.id, report_id=report.id) }}">
                  {{ report.forms | length }} tasks<span class="govuk-visually-hidden"> in report for {{ report.name }}</span>
                </a>
              {% endif %}
            {% else %}
              <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.list_report_tasks', grant_id=grant.id, report_id=report.id) }}">
                {{ report.forms | length }} tasks<span class="govuk-visually-hidden"> in report for {{ report.name }}</span>
              </a>
            {% endif %}
          {% endset %}


          {% set submissionsText %}
            {# TODO: Once reports have a draft/live status, this should also take that into account (ie if live, only show live submissions) #}
            {% if report.live_submissions %}
              {% trans count=report.live_submissions | length %}{{ count }} submission{% pluralize %}{{ count }} submissions{% endtrans %}
            {% else %}
              {% trans count=report.test_submissions | length %}{{ count }} test submission{% pluralize %}{{ count }} test submissions{% endtrans %}
            {% endif %}
            <span class="govuk-visually-hidden">for {{ report.name }}</span>
          {% endset %}


          {% set submissionsHtml %}
            <a
              class="govuk-link govuk-link--no-visited-state"
              href="{{ url_for('deliver_grant_funding.list_submissions', grant_id=grant.id, report_id=report.id, submission_mode=enum.submission_mode.LIVE if report.live_submissions else enum.submission_mode.TEST) }}">
              {{ submissionsText }}
            </a>
          {% endset %}

          {% set actions = [] %}
          {% if grant_admin %}
            {% do actions.append({"text": "Change name", "visuallyHiddenText": report.title, "href": url_for("deliver_grant_funding.change_report_name", grant_id=grant.id, report_id=report.id), "classes": "govuk-link--no-visited-state" }) %}
            {% if not report.live_submissions %}
              {% do actions.append({"text": "Delete", "visuallyHiddenText": report.title, "href": url_for("deliver_grant_funding.list_reports", grant_id=grant.id, delete=report.id), "classes": "govuk-link--no-visited-state" }) %}
            {% endif %}
          {% endif %}

          {{
            govukSummaryList({
            	"card": {
            		"title": {"text": report.name},
            		"actions": {
            			"items": actions,
            		},
            	},
            	"rows": [
            		{
            			"key": {"text": "Report"},
            			"value": {"text": formSectionsAndTasksText},
            		},
            		{"key": {"text": "Submissions"}, "value": {"html": submissionsHtml} },
            		{"key": {"text": "Created by"}, "value": {"text": report.created_by.email} },
            		{"key": {"text": "Last updated"}, "value": {"text": format_date(report.updated_at_utc)} },
            	],
            })
          }}
        {% endfor %}
      {% endif %}

      {% if grant_admin %}
        {{
          govukButton({
            "text": "Add a monitoring report" if not grant.reports else "Add another monitoring report",
            "classes": "" if not grant.reports else "govuk-button--secondary",
            "href": url_for('deliver_grant_funding.set_up_report', grant_id=grant.id)
          })
        }}
      {% endif %}
    </div>
  </div>
{% endblock content %}
