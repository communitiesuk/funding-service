{% extends "deliver_grant_funding/grant_base.html" %}
{% from "govuk_frontend_jinja/components/summary-list/macro.html" import govukSummaryList %}
{% from "govuk_frontend_jinja/components/breadcrumbs/macro.html" import govukBreadcrumbs %}

{% set page_title = "Reports" %}
{% set active_item_identifier = "reports" %}
{% set grant_admin = authorisation_helper.is_grant_admin(grant.id, current_user) %}

{% block beforeContent %}
  {{
    govukBreadcrumbs(params={
      "items": [
        {"text": "Reports", "href": url_for("deliver_grant_funding.list_reports", grant_id=grant.id)},
        {"text": report.name},
      ],
    })
  }}
{% endblock beforeContent %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h1 class="govuk-heading-l">
        <span class="govuk-caption-l">{{ report.name }}</span>
        Monitoring report tasks
      </h1>
    </div>
    <div class="govuk-grid-column-one-third govuk-!-text-align-right">
      <button class="govuk-button govuk-button--secondary">Preview report</button>
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      {% if not report.forms %}
        <p class="govuk-body">This monitoring report has no tasks.</p>
        {% if grant_admin %}
          <p class="govuk-body">
            <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.add_task', grant_id=grant.id, report_id=report.id) }}"> Add a task </a>
          </p>
        {% endif %}
      {% else %}
        {% set rows = [] %}
        {% for form in report.forms %}
          {% set questionsHtml %}
            {% if grant_admin %}
              {% if form.questions | length == 0 %}
                <a class="govuk-link govuk-link--no-visited-state" href="#">Add questions<span class="govuk-visually-hidden"> to {{ form.title }}</span></a>
              {% else %}
                <a class="govuk-link govuk-link--no-visited-state" href="#">{{ form.questions | length }} questions<span class="govuk-visually-hidden"> in {{ form.title }}</span></a>
              {% endif %}
            {% else %}
              {{ form.questions | length }}
              questions<span class="govuk-visually-hidden"> in {{ form.title }}</span>
            {% endif %}
          {% endset %}
          {% set actions = [] %}
          {% if grant_admin %}
            {% do actions.append({"text": "Manage", "visuallyHiddenText": form.title, "href": url_for('deliver_grant_funding.manage_form', grant_id=grant.id, form_id=form.id), "classes": "govuk-link--no-visited-state"}) %}
          {% else %}
            {# Append some empty actions in order to keep the layout visually the same - might need to think about this more when we have examples #}
            {% do actions.append({}) %}
          {% endif %}
          {%
            do rows.append(
            {
              "key": {"text": form.title, "classes": "govuk-!-font-weight-regular govuk-!-width-one-half"},
              "value": {"html": questionsHtml, "classes": "govuk-!-width-one-quarter"},
              "actions": {
                "items": actions,
                "classes": "govuk-!-width-one-third",
              },
            })
          %}
        {% endfor %}

        {{
          govukSummaryList({
            "card": {
              "title": {"text": "Tasks"},
              "actions": {
                "items": [
                  {"text": "Add another task", "href": url_for("deliver_grant_funding.add_task", grant_id=grant.id, report_id=report.id), "classes": "govuk-link--no-visited-state"}
                ] if grant_admin else [],
               }
            },
            "rows": rows
          })
        }}
      {% endif %}
    </div>
  </div>
{% endblock content %}
