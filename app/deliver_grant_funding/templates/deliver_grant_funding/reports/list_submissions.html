{% from "deliver_grant_funding/macros/deliver_grant_funding_reports_breadcrumb.html" import deliver_grant_funding_reports_breadcrumb %}
{% from "govuk_frontend_jinja/components/table/macro.html" import govukTable %}
{% from "common/partials/mhclg-test-banner.html" import mhclgInlinePageTestDataBanner %}
{% from "common/macros/status.html" import submissionStatusTag with context %}
{% from "govuk_frontend_jinja/components/button/macro.html" import govukButton %}
{% from "govuk_frontend_jinja/components/notification-banner/macro.html" import govukNotificationBanner %}
{% extends "deliver_grant_funding/grant_base.html" %}

{% set page_title = "Submissions - " ~ report.name %}
{% set active_item_identifier = "reports" %}

{% block beforeContent %}
  {% if helper.is_test_mode %}
    {{ mhclgInlinePageTestDataBanner("Test submissions") }}
  {% endif %}
  {{ deliver_grant_funding_reports_breadcrumb(grant=grant, this_page_breadcrumb_item={"text":"Submissions"}) }}
{% endblock beforeContent %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      {% with flashes = get_flashed_messages(category_filter=[enum.flash_message_type.TEST_SUBMISSION_RESET ]) %}
        {% if flashes %}
          {% set test_submission_reset_html %}
          {% set user_can_test_grant_recipient_journey = report.grant.test_grant_recipients and report.grant in current_user.access_grants %}
            <h3 class="govuk-notification-banner__heading">Test submission reset</h3>
            <p class="govuk-body">Your team's test submission has been reset.</p>

            {% if user_can_test_grant_recipient_journey %}
              <p class="govuk-body">
                To start again you can
                <a class="govuk-notification-banner__link" href="{{ url_for('deliver_grant_funding.start_test_grant_recipient_journey', grant_id=report.grant.id, report_id=report.id) }}"> test the grant recipient journey for this report </a
                >.
              </p>
            {% endif %}
          {% endset %}
          {{
            govukNotificationBanner({
              "html": test_submission_reset_html,
              "type":"success"
            })
          }}
        {% endif %}
      {% endwith %}

      <h1 class="govuk-heading-l">
        <span class="govuk-caption-l">{{ report.name }}</span>
        Monitoring reports
      </h1>
      <p class="govuk-body">View the information that has been provided by grant recipients in their monitoring reports.</p>
      <p class="govuk-body">
        {{
          govukButton({
            "text": "Export as CSV",
            "href": url_for("deliver_grant_funding.export_report_submissions", grant_id=grant.id, report_id=report.id, submission_mode=submission_mode, export_format='csv'),
            "classes": "govuk-button--secondary govuk-!-margin-bottom-2",
          })
        }}
        {{
          govukButton({
            "text": "Export as JSON",
            "href": url_for("deliver_grant_funding.export_report_submissions", grant_id=grant.id, report_id=report.id, submission_mode=submission_mode, export_format='json'),
            "classes": "govuk-button--secondary govuk-!-margin-bottom-2",
          })
        }}
      </p>
    </div>
    <div class="govuk-grid-column-full">
      {% if report.allow_multiple_submissions %}
        {% set rows=[] %}
        {% for submission_helper in helper.submission_helpers.values() | sort(attribute="submission.grant_recipient.organisation.name,display_name") %}
          {% set link_to_submission %}
            <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.view_submission', grant_id=grant.id, submission_id=submission_helper.submission.id) }}" data-submission-link>
              {{ submission_helper.display_name }}
            </a>
          {% endset %}
          {%
            do rows.append([
              {
                "html": link_to_submission,
              }, {
                "text": submission_helper.submission.grant_recipient.organisation.name,
              }, {
                "html": submissionStatusTag(submission_helper.status, submission_helper.is_overdue)
              }, {
                "text": format_date_short(submission_helper.submission.updated_at_utc)
              }
            ])
          %}
        {% else %}
          {% set no_submissions_text %}
            <span>No submissions found for this monitoring report</span>
          {% endset %}
          {%
            do rows.append([
              {
                "html": no_submissions_text,
                "colspan": 4
              }
            ])
          %}
        {% endfor %}

        {{
          govukTable({
            "captionClasses": "govuk-table__caption--m",
            "head": [
              { "text": (report.submission_name_question.name[0]|upper + report.submission_name_question.name[1:]) if report.submission_name_question else "Submission", "classes": "govuk-!-width-one-third" },
              { "text": "Grant recipient" },
              { "text": "Status" },
              { "text": "Last updated" }
            ],
            "rows": rows
          })
        }}
      {% else %}
        {% set rows=[] %}
        {% for grant_recipient in helper.grant_recipients | sort(attribute="organisation.name") %}
          {% set grant_recipient_submission_helper = helper.grant_recipients_submission_helpers[grant_recipient.id] %}
          {% set link_to_submission %}
            {% if grant_recipient_submission_helper %}
              <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.view_submission', grant_id=grant.id, submission_id=grant_recipient_submission_helper.submission.id) }}" data-submission-link>
                {{ grant_recipient.organisation.name }}
              </a>
            {% else %}
              {{ grant_recipient.organisation.name }}
            {% endif %}
          {% endset %}
          {%
            do rows.append([
              {
                "html": link_to_submission,
              }, {
                "html": submissionStatusTag(grant_recipient_submission_helper.status if grant_recipient_submission_helper else enum.submission_status.NOT_STARTED, grant_recipient_submission_helper.is_overdue if grant_recipient_submission_helper else report.is_overdue)
              }, {
                "text": format_date_short(grant_recipient_submission_helper.submission.updated_at_utc) if grant_recipient_submission_helper else ''
              }
            ])
          %}
        {% else %}
          {% set no_collections_text %}
            <span>No submissions found for this monitoring report</span>
          {% endset %}
          {%
            do rows.append([
              {
                "html": no_collections_text,
                "colspan": 3
              }
            ])
          %}
        {% endfor %}

        {{
          govukTable({
            "captionClasses": "govuk-table__caption--m",
            "head": [
              { "text": "Grant recipient", "classes": "govuk-!-width-one-half" },
              { "text": "Status" },
              { "text": "Last updated" }
            ],
            "rows": rows
          })
        }}
      {% endif %}
    </div>
  </div>
{% endblock content %}
