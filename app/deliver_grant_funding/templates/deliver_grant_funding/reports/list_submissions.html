{% from "deliver_grant_funding/macros/deliver_grant_funding_reports_breadcrumb.html" import deliver_grant_funding_reports_breadcrumb %}
{% from "govuk_frontend_jinja/components/table/macro.html" import govukTable %}
{% from "common/partials/mhclg-test-banner.html" import mhclgTestBanner %}
{% from "common/macros/status.html" import submissionStatusTag with context %}
{% from "govuk_frontend_jinja/components/button/macro.html" import govukButton %}
{% extends "deliver_grant_funding/grant_base.html" %}

{% set page_title = "Submissions - " ~ report.name %}
{% set active_item_identifier = "reports" %}

{% block beforeContent %}
  {% if helper.is_test_mode %}
    {{ mhclgTestBanner("Test submissions") }}
  {% endif %}
  {{ deliver_grant_funding_reports_breadcrumb(grant=grant, this_page_breadcrumb_item={"text":"Submissions"}) }}
{% endblock beforeContent %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h1 class="govuk-heading-l">
        <span class="govuk-caption-l">{{ report.name }}</span>
        Monitoring reports
      </h1>
      <p class="govuk-body">View the information that has been provided by grant recipients in their monitoring reports.</p>
      <p class="govuk-body">
        {{
          govukButton({
            "text": "Export as CSV",
            "href": url_for("deliver_grant_funding.export_report_submissions", grant_id=grant.id, report_id=report.id, submission_mode=submission_mode, export_format='csv'),
            "classes": "govuk-button--secondary govuk-!-margin-bottom-2",
          })
        }}
        {{
          govukButton({
            "text": "Export as JSON",
            "href": url_for("deliver_grant_funding.export_report_submissions", grant_id=grant.id, report_id=report.id, submission_mode=submission_mode, export_format='json'),
            "classes": "govuk-button--secondary govuk-!-margin-bottom-2",
          })
        }}
      </p>
    </div>
    <div class="govuk-grid-column-full">
      {% set rows=[] %}
      {% if helper.is_test_mode %}
        {% for submission_helper in helper.submission_helpers.values() %}
          {% set link_to_submission %}
            <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.view_submission', grant_id=grant.id, submission_id=submission_helper.submission.id) }}" data-submission-link>
              {{ submission_helper.submission.created_by.email }}
            </a>
          {% endset %}
          {%
            do rows.append([
              {
                "html": link_to_submission,
              }, {
                "html": submissionStatusTag(submission_helper.status)
              }, {
                "text": format_date_short(submission_helper.submission.updated_at_utc)
              }
            ])
          %}
        {% else %}
          {% set no_collections_text %}
            <span>No submissions found for this monitoring report</span>
          {% endset %}
          {%
            do rows.append([
              {
                "html": no_collections_text,
                "colspan": 3
              }
            ])
          %}
        {% endfor %}
      {% else %}
        {% for grant_recipient in helper.grant_recipients %}
          {% set grant_recipient_submission_helper = helper.grant_recipients_submission_helpers[grant_recipient.id] %}
          {% set link_to_submission %}
            {% if grant_recipient_submission_helper %}
              <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.view_submission', grant_id=grant.id, submission_id=grant_recipient_submission_helper.submission.id) }}" data-submission-link>
                {{ grant_recipient.organisation.name }}
              </a>
            {% else %}
              {{ grant_recipient.organisation.name }}
            {% endif %}
          {% endset %}
          {%
            do rows.append([
              {
                "html": link_to_submission,
              }, {
                "html": submissionStatusTag(grant_recipient_submission_helper.status if grant_recipient_submission_helper else enum.submission_status.NOT_STARTED)
              }, {
                "text": format_date_short(grant_recipient_submission_helper.submission.updated_at_utc) if grant_recipient_submission_helper else ''
              }
            ])
          %}
        {% else %}
          {% set no_collections_text %}
            <span>No submissions found for this monitoring report</span>
          {% endset %}
          {%
            do rows.append([
              {
                "html": no_collections_text,
                "colspan": 3
              }
            ])
          %}
        {% endfor %}
      {% endif %}

      {{
        govukTable({
          "captionClasses": "govuk-table__caption--m",
          "head": [
            { "text": "User" if helper.is_test_mode else "Grant recipient", "classes": "govuk-!-width-one-half" },
            { "text": "Status" },
            { "text": "Last updated" }
          ],
          "rows": rows
        })
      }}
    </div>
  </div>
{% endblock content %}
