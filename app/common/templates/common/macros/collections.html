{% from "govuk_frontend_jinja/components/back-link/macro.html" import govukBackLink %}
{% from "govuk_frontend_jinja/components/task-list/macro.html" import govukTaskList %}
{% from "govuk_frontend_jinja/components/summary-list/macro.html" import govukSummaryList %}
{% from "common/macros/status.html" import status with context %}
{% from "common/partials/mhclg-test-banner.html" import mhclgStopTestingBanner %}

{% macro collection_before(runner, override_back_link=None) %}
  {% if runner.submission.is_test %}
    {{ mhclgStopTestingBanner(runner) }}
  {% endif %}
  {{ govukBackLink({ "text": "Back", "href": override_back_link or runner.back_url }) }}
{% endmacro %}

{% macro collection_question_with_add_another_summary_page(runner) %}
  {% if runner.add_another_summary_context %}
    {{ collection_add_another_summary(runner) }}
  {% else %}
    {{ collection_question(runner) }}
  {% endif %}
{% endmacro %}

{% macro collection_question(runner) %}
  {% set is_group = runner.component.is_group %}
  {% set questions = runner.questions if is_group else [runner.component] %}
  {% set form = runner.question_form %}
  {% set questionAsPageHeading = not runner.component.guidance_heading and not is_group %}

  <form method="post" novalidate>
    {{ form.csrf_token }}

    {# bite the bullet and make this an explicit property #}
    {% if runner.add_another_index is not none and runner.component.add_another_container %}
      {# if the add another container is itself on the same page having the caption and the page heading the same is not ideal #}
      {% if runner.component.is_group and runner.component == runner.component.add_another_container %}
        <span class="govuk-caption-l">{{ runner.component.form.title }}</span>
      {% else %}
        <span class="govuk-caption-l">{{ runner.component.add_another_container.name }} ({{ runner.add_another_index + 1 }})</span>
      {% endif %}
    {% else %}  
      <span class="govuk-caption-l">{{ runner.component.form.title }}</span>
    {% endif %}
    {% if runner.component.guidance_heading %}
      <h1 class="govuk-heading-l">{{ runner.component.guidance_heading }}</h1>
      {{ runner.interpolate(runner.component.guidance_body) | govuk_markdown }}
    {% elif is_group %}
      {# wip: refactor it all - a much more streamlined way of doing this! #}
      {% if runner.component == runner.component.add_another_container %}
        {% set heading = runner.component.name ~ " (" ~ (runner.add_another_index + 1) ~ ")" %}
      {% else %}
        {% set heading = runner.component.name %}
      {% endif %}

      <h1 class="govuk-heading-l">{{ heading }}</h1>
    {% endif %}

    {# https://github.com/alphagov/govuk-frontend/issues/1841 #}
    {# GOV.UK Frontend macros don't let you add captions to label/legend-headings that are outside of the <h> element #}
    {# We want the caption outside of the <h> element to keep things more concise and understandable to screenreader users #}
    {# So we just manually add the caption here. #}
    {% for question in questions %}
      {% if question.data_type == enum.question_type.TEXT_MULTI_LINE %}
        {{
          form.render_question(
            question,
            params={
              "label": {"classes": "govuk-label--l" if questionAsPageHeading else "govuk-!-font-weight-bold", "isPageHeading": questionAsPageHeading},
              "maxwords": question.presentation_options.word_limit,
              "rows": question.presentation_options.rows,
              "attributes": {"data-module": "paste-html-bullets-as-markdown"},
            }
          )
        }}
      {% elif question.data_type == enum.question_type.TEXT_SINGLE_LINE or question.data_type == enum.question_type.EMAIL or question.data_type == enum.question_type.URL %}
        {{
          form.render_question(
            question,
            params={
              "label": {"classes": "govuk-label--l" if questionAsPageHeading else "govuk-!-font-weight-bold", "isPageHeading": questionAsPageHeading}
            }
          )
        }}
      {% elif question.data_type == enum.question_type.INTEGER %}
        {{
          form.render_question(
            question,
            params={
              "label": {"classes": "govuk-label--l" if questionAsPageHeading else "govuk-!-font-weight-bold" ,"isPageHeading": questionAsPageHeading},
              "inputmode": "numeric",
              "spellcheck": false,
              "classes": question.presentation_options.width or '',
              "prefix": {"text": question.presentation_options.prefix or ''},
              "suffix": {"text": question.presentation_options.suffix or ''}
            }
          )
        }}
      {% elif question.data_type == enum.question_type.YES_NO %}
        {{
          form.render_question(
            question,
            params={
              "fieldset": {"legend": {"text": runner.interpolate(question.text), "classes": "govuk-fieldset__legend--l" if questionAsPageHeading else "govuk-!-font-weight-bold", "isPageHeading": questionAsPageHeading} },
              "classes": "govuk-radios--inline"
            }
          )
        }}
      {% elif question.data_type == enum.question_type.CHECKBOXES %}
        {{
          form.render_question(
            question,
            params={
              "fieldset": {"legend": {"text": runner.interpolate(question.text), "classes": "govuk-fieldset__legend--l" if questionAsPageHeading else "govuk-!-font-weight-bold", "isPageHeading": questionAsPageHeading} },
            }
          )
        }}
      {% elif question.data_type == enum.question_type.DATE %}
        {{
          form.render_question(
            question,
            params={
              "fieldset": {"legend": {"text": runner.interpolate(question.text), "classes": "govuk-fieldset__legend--l" if questionAsPageHeading else "govuk-!-font-weight-bold", "isPageHeading": questionAsPageHeading} },
              "spellcheck": false
            }
          )
        }}
      {% elif question.data_type == enum.question_type.RADIOS %}
        {% if form.get_question_field(question).widget.is_accessible_autocomplete %}
          {#
            `govuk-!-width-full` override here to line up with the default width of the accessible autocomplete component. We could potentially do something smarter, like copy the class
            from here to the enhanced autocomplete, but leaving that for a future increment.
          #}
          {{
            form.render_question(
              question,
              params={
                "label": {"classes": "govuk-fieldset__legend--l" if questionAsPageHeading else "govuk-!-font-weight-bold", "isPageHeading": questionAsPageHeading},
                "classes": "govuk-!-width-full"
              }
            )
          }}
        {% else %}
          {{
            form.render_question(
              question,
              params={
                "fieldset": {"legend": {"text": runner.interpolate(question.text), "classes": "govuk-fieldset__legend--l" if questionAsPageHeading else "govuk-!-font-weight-bold", "isPageHeading": questionAsPageHeading} },
              }
            )
          }}
        {% endif %}
      {% endif %}
    {% endfor %}
    {{ form.submit }}
  </form>
{% endmacro %}

{% macro collection_check_your_answers(runner) %}
  {% set form = runner.form %}
  {% set submission = runner.submission %}

  <span class="govuk-caption-l">{{ form.title }}</span>
  <h1 class="govuk-heading-l">{{ "Your submitted answers" if submission.is_completed else "Check your answers" }}</h1>

  {% set groups_for_later = [] %}

  {% set rows = [] %}
  {% for question in submission.cached_get_ordered_visible_questions(form) %}
    {% set is_add_another_group = false %}

    {# wip: come back and tidy all of this multiple passes up later #}
    {% if not (question.add_another_container and question.add_another_container in groups_for_later) %}

      {% if question.add_another_container and question.add_another_container.id not in groups_for_later %}
        {% do groups_for_later.append(question.add_another_container) %}
        {% set is_add_another_group = true %}
      {% endif %}

      {% if is_add_another_group %}
        {% set count = submission.get_count_for_add_another(question.add_another_container) %}

        {# wip: this should happen somewhere good #}
        {% set status = namespace(all_answered = true) %}
        {% for i in range(count) %}
          {% set (summary, is_answered) = submission.get_answer_summary_for_add_another(question, add_another_index=i) %}
          {% if not is_answered %}
            {% set status.all_answered = false %}
          {% endif %}
        {% endfor %}

        {% if count and status.all_answered %}
          {% set value_html %}
            <p class="govuk-body">You have added {{ count }} answers</p>

            <p class="govuk-body">
              <a href="#{{ question.add_another_container.id }}-answers" class="govuk-link govuk-link--no-visited-state">Answers for {{ question.add_another_container.name | lower }}</a>
            </p>
          {% endset %}

          {%
            set actions = (
            []
            if submission.is_completed else
            [
              {
                "href": runner.to_url(enum.form_runner_state.QUESTION, question=question, source=enum.form_runner_state.CHECK_YOUR_ANSWERS),
                "text": "Change",
                "visuallyHiddenText": question.add_another_container.name
              }
            ]
            )
          %}
          {%
            do rows.append({
              "key": {"text": runner.interpolate(question.add_another_container.text)},
              "value": {"html": value_html},
              "actions": {"items": actions},
            })
          %}

        {% else %}

          {% set valueLink %}
            <a href="{{ runner.to_url(enum.form_runner_state.QUESTION, question=question, source=enum.form_runner_state.CHECK_YOUR_ANSWERS) }}" class="govuk-link govuk-link--no-visited-state">{{ "Enter" if not count else "Finish entering " }} {{ question.add_another_container.name | lower }}</a>
          {% endset %}
          {%
            do rows.append({
              "key": {"text": runner.interpolate(question.add_another_container.text)},
              "value": {"html": valueLink}
            })
          %}

        {% endif %}

      {% else %}
        {% set answer = submission.cached_get_answer_for_question(question.id) %}
        {% if answer is not none %}
          {% set value_html %}
            {% include answer._render_answer_template %}
          {% endset %}

          {# todo: can we "anchor" or link to the specific question if we're going to be changing a question on a same page group #}
          {%
            set actions = (
            []
            if submission.is_completed else
            [
              {
                "href": runner.to_url(enum.form_runner_state.QUESTION, question=question, source=enum.form_runner_state.CHECK_YOUR_ANSWERS),
                "text": "Change",
                "visuallyHiddenText": question.name
              }
            ]
            )
          %}
          {%
            do rows.append({
              "key": {"text": runner.interpolate(question.text)},
              "value": {"html": value_html},
              "actions": {"items": actions},
            })
          %}
        {% else %}
          {% set valueLink %}
            <a href="{{ runner.to_url(enum.form_runner_state.QUESTION, question=question, source=enum.form_runner_state.CHECK_YOUR_ANSWERS) }}" class="govuk-link govuk-link--no-visited-state">Enter {{ question.name }}</a>
          {% endset %}
          {%
            do rows.append({
              "key": {"text": runner.interpolate(question.text)},
              "value": {"html": valueLink}
            })
          %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {{
    govukSummaryList({
      "classes": "govuk-!-margin-bottom-9",
      "rows": rows
    })
  }}

  {# wip: this will duplicate all the logic above, should be wrapped up in a macro! #}
  {% for add_another_group in groups_for_later %}
    {% set count = submission.get_count_for_add_another(add_another_group) %}

    {# wip: this should happen somewhere good #}
    {% set status = namespace(all_answered = true) %}
    {% for i in range(count) %}
      {% set (summary, is_answered) = submission.get_answer_summary_for_add_another(add_another_group, add_another_index=i) %}
      {% if not is_answered %}
        {% set status.all_answered = false %}
      {% endif %}
    {% endfor %}

    {# todo: wip: decide if we should show answers for incomplete add another groups, maybe that would stop you from going and clicking "Change" in the top level summary table #}
    {# might even err on the side of not doing this right away #} 
    {% if count and status.all_answered %}
      <div class="govuk-!-margin-bottom-6">
        <h2 class="govuk-heading-m" id="{{ add_another_group.id }}-answers">Answers for {{ add_another_group.name | lower }}</h2>

        {# for each entry #}
        {% for i in range(count) %}

          {% set rows = [] %}
          {% set (summary, is_answered) = submission.get_answer_summary_for_add_another(add_another_group, add_another_index=i) %}
          
          {# for each question #}
          {% for question in submission.cached_get_ordered_visible_questions(add_another_group) %}

            {# wip: for now there will be no missing answers although we might want to lift that restriction and let you change them from here #}
            {% set answer = submission.cached_get_answer_for_question(question.id, add_another_index=i) %}
            {% if answer is not none %}
              {% set value_html %}
                {% include answer._render_answer_template %}
              {% endset %}

              {%
                set actions = (
                []
                if submission.is_completed else
                [
                  {
                    "href": runner.to_url(enum.form_runner_state.QUESTION, question=question, source=enum.form_runner_state.CHECK_YOUR_ANSWERS, add_another_index=i),
                    "text": "Change",
                    "visuallyHiddenText": question.name
                  }
                ]
                )
              %}
              {%
                do rows.append({
                  "key": {"text": runner.interpolate(question.text)},
                  "value": {"html": value_html},
                  "actions": {"items": actions},
                })
              %}
            {% else %}
              {% set valueLink %}
                <a href="{{ runner.to_url(enum.form_runner_state.QUESTION, question=question, source=enum.form_runner_state.CHECK_YOUR_ANSWERS, add_another_index=i) }}" class="govuk-link govuk-link--no-visited-state">Enter {{ question.name }}</a>
              {% endset %}
              {%
                do rows.append({
                  "key": {"text": runner.interpolate(question.text)},
                  "value": {"html": valueLink}
                })
              %}
            {% endif %}
    
          {% endfor %} {# end questions #}
  
          {{
            govukSummaryList({
              "card": {
                "title": {
                  "text": summary
                }
              },
              "rows": rows
            })
          }}

        {% endfor %}
      </div>
    {% endif %}
  {% endfor %}
  {# {# {% for add_another_group in groups_for_later %}
    {% set rows = [] %}

    {% set count = submission.get_count_for_add_another(add_another_group) %}

    {% for i in range(count) %} 

    {% for question in submission.cached_get_ordered_visible_questions(add_another_group) %}

        {% if question.add_another_container and question.add_another_container.id not in groups_for_later %}
          {% do groups_for_later.append(question.add_another_container) %}
          {% set is_add_another_group = true %}
        {% endif %}

        {% set answer = submission.cached_get_answer_for_question(question.id) %}
        {% if answer is not none %}
          {% set value_html %}
            {% include answer._render_answer_template %}
          {% endset %}

          {%
            set actions = (
            []
            if submission.is_completed else
            [
              {
                "href": runner.to_url(enum.form_runner_state.QUESTION, question=question, source=enum.form_runner_state.CHECK_YOUR_ANSWERS),
                "text": "Change",
                "visuallyHiddenText": question.name
              }
            ]
            )
          %}
          {%
            do rows.append({
              "key": {"text": runner.interpolate(question.text)},
              "value": {"html": value_html},
              "actions": {"items": actions},
            })
          %}
        {% else %}
          {% set valueLink %}
            <a href="{{ runner.to_url(enum.form_runner_state.QUESTION, question=question, source=enum.form_runner_state.CHECK_YOUR_ANSWERS) }}" class="govuk-link govuk-link--no-visited-state">Enter {{ question.name }}</a>
          {% endset %}
          {%
            do rows.append({
              "key": {"text": runner.interpolate(question.text)},
              "value": {"html": valueLink}
            })
          %}
        {% endif %}
      {% endif %}
    {% endfor %}

    {{
      govukSummaryList({
        "classes": "govuk-!-margin-bottom-9",
        "rows": rows
      })
    }}

  {% endfor %} #}

  {% if submission.is_completed %}
    <p class="govuk-body">
      <a class="govuk-link govuk-link--no-visited-state" href="{{ runner.to_url(enum.form_runner_state.TASKLIST) }}">Return to the task list</a>
    </p>
  {% else %}
    {% set check_your_answers_form = runner.check_your_answers_form %}
    <form method="post" novalidate>
      {{ check_your_answers_form.csrf_token }}
      {% set all_questions_answered = submission.cached_get_all_questions_are_answered_for_form(form).all_answered %}
      {% if all_questions_answered %}
        {{
          check_your_answers_form.section_completed(params={
            "fieldset": {
              "legend": {
                "text": "Have you completed this task?",
                "isPageHeading": false,
                "classes": "govuk-fieldset__legend--m"
              }
            }
          })
        }}
      {% endif %}
      {{ check_your_answers_form.submit }}
    </form>
  {% endif %}
{% endmacro %}

{% macro collection_tasklist(runner) %}
  {% set submission = runner.submission %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      {% set forms = submission.get_ordered_visible_forms() %}
      {% if not forms %}
        <p class="govuk-body">This collection has no forms.</p>
      {% else %}
        {% set rows=[] %}
        {% for form in forms %}
          {% set first_question = submission.get_first_question_for_form(form) %}
          {%
            set link_href = (
              ''
              if not first_question else
              runner.to_url(enum.form_runner_state.QUESTION, question=first_question)
              if submission.get_status_for_form(form) == enum.submission_status.NOT_STARTED else
              runner.to_url(enum.form_runner_state.CHECK_YOUR_ANSWERS, form=form, source=enum.form_runner_state.TASKLIST)
            )
          %}
          {%
            do rows.append({
              "title": {
                "text": form.title,
              },
              "status": {
                "html": status(submission.get_tasklist_status_for_form(form)) ,
              },
              "href": link_href,
            })
          %}
        {% endfor %}

        {{
          govukTaskList({
            "idPrefix": submission.collection.slug,
            "items": rows
          })
        }}
      {% endif %}
    </div>
  </div>
  {% if not submission.is_completed %}
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds">
        {% if not submission.all_forms_are_completed %}
          <p class="govuk-body">You must complete all tasks before you can submit.</p>
        {% endif %}
        <form method="post" novalidate>
          {{ runner.tasklist_form.csrf_token }}

          {{
            runner.tasklist_form.submit(params={
              "text": "Submit",
              "disabled": not submission.all_forms_are_completed
            })
          }}
        </form>
      </div>
    </div>
  {% endif %}
{% endmacro %}

{% macro collection_add_another_summary(runner) %}
  {% set add_another_container = runner.component.add_another_container %}

  <span class="govuk-caption-l">{{ runner.component.form.title }}</span>
  <h1 class="govuk-heading-l">{{ add_another_container.name }}</h1>

  {% set rows = [] %}
  {% set number_of_entries = runner.submission.get_count_for_add_another(add_another_container) %}

  {% if number_of_entries %}
    <h2 class="govuk-heading-s">You have added {{ number_of_entries }} {{ add_another_container.name | lower }}</h2>
    <dl class="govuk-summary-list">
      {% for i in range(number_of_entries) %}
        {# todo: check if the entry is complete or if we should prompt the user to complete it with a different link #}
        {% set (summary, is_answered) = runner.submission.get_answer_summary_for_add_another(add_another_container, add_another_index=i) %}

        <div class="govuk-summary-list__row">
          {% if not is_answered %}
            <dt class="govuk-summary-list__value">
              <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.ask_a_question', grant_id=runner.submission.grant.id, submission_id=runner.submission.id, question_id=runner.component.add_another_container.id if not runner.component.add_another_container.is_group else runner.component.add_another_container.cached_questions[0].id, add_another_index=i) }}"> Enter missing information for {{ to_ordinal(i + 1) }} {{ add_another_container.name | lower }} {{ "(" ~ summary ~ ")" if summary else "" }} </a>
            </dt>
          {% else %}
            <dt class="govuk-summary-list__value">{{ summary }}</dt>
            <dd class="govuk-summary-list__actions govuk-!-width-one-third">
              <ul class="govuk-summary-list__actions-list">
                <li class="govuk-summary-list__actions-list-item">
                  <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('deliver_grant_funding.ask_a_question', grant_id=runner.submission.grant.id, submission_id=runner.submission.id, question_id=runner.component.add_another_container.id if not runner.component.add_another_container.is_group else runner.component.add_another_container.cached_questions[0].id, add_another_index=i) }}">
                    Change
                    <span class="govuk-visually-hidden"> {{ summary if summary else to_ordinal(i + 1) ~ " " ~ (add_another_container.name | lower) }}</span>
                  </a>
                </li>
                <li class="govuk-summary-list__actions-list-item">
                  <a class="govuk-link govuk-link--no-visited-state" href="#">
                    Remove
                    <span class="govuk-visually-hidden"> {{ summary if summary else to_ordinal(i + 1) ~ " " ~ (add_another_container.name | lower) }}</span>
                  </a>
                </li>
              </ul>
            </dd>
          {% endif %}
        </div>
      {% endfor %}
    </dl>

    <form method="post" novalidate>
      {{ runner.add_another_summary_form.csrf_token }}

      {{
        runner.add_another_summary_form.add_another(params={
          "fieldset": {
            "legend": {
              "text": "Do you need to add another answer?",
              "isPageHeading": false,
              "classes": "govuk-fieldset__legend--m"
            }
          }
        })
      }}

      {{ runner.add_another_summary_form.submit }}
    </form>
  {% else %}
    <p class="govuk-body">You have not added any {{ add_another_container.name | lower }}.</p>

    <form method="post" novalidate>
      {{ runner.add_another_summary_form.csrf_token }}
      {{
        runner.add_another_summary_form.add_another(params={
          "fieldset": {},
          "classes": "govuk-!-display-none",
          "value": "yes"
        })
      }}
      {{
        runner.add_another_summary_form.submit(params={
          "text": "Add the first answer",
          "classes": "govuk-!-margin-top-3"
        })
      }}
    </form>
  {% endif %}
{% endmacro %}
