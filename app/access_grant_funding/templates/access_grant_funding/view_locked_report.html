{% extends "access_grant_funding/base.html" %}
{% from "govuk_frontend_jinja/components/back-link/macro.html" import govukBackLink %}
{% from "common/macros/submissions.html" import answers_summary_list with context %}
{% from "common/macros/status.html" import submissionStatusTag with context %}

{% set page_title = submission.name if submission.is_submitted else ("Review report: " ~ submission.name) %}

{% set mainClasses = "app-full-screen-with-section-nav" %}

{% set active_item_identifier = "reports" %}
{% block beforeContent %}
  {{ super() }}
  {{
    govukBackLink({
      "href": url_for("access_grant_funding.list_reports", organisation_id=grant_recipient.organisation.id, grant_id=grant_recipient.grant.id),
      "text": "Back to reports"
    })
  }}
{% endblock beforeContent %}

{% set should_certify = authorisation_helper.is_access_grant_certifier(submission.grant.id, submission.submission.grant_recipient.organisation_id, current_user) and submission.is_awaiting_sign_off %}
{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-one-quarter-from-desktop app-section-nav-container">
      <nav aria-label="Report sections">
        <ul class="govuk-list app-section-nav-list">
          <li class="app-section-nav-list__item app-section-nav-list__item--active"><a class="govuk-link govuk-link--no-visited-state" href="#submission">{{ page_title }}</a></li>

          {% for form in submission.get_ordered_visible_forms() %}
            <li class="app-section-nav-list__item"><a class="govuk-link govuk-link--no-visited-state" href="#form-{{ form.id }}">{{ form.title }}</a></li>
          {% endfor %}

          {% if should_certify %}
            <li class="app-section-nav-list__item"><a class="govuk-link govuk-link--no-visited-state" href="#sign-off-and-submit-report">Sign off and submit report</a></li>
          {% endif %}
        </ul>
      </nav>

      <a
        class="govuk-button govuk-button--secondary"
        download
        href="{{ url_for('access_grant_funding.export_report_pdf', organisation_id=grant_recipient.organisation.id, grant_id=grant_recipient.grant.id, submission_id=submission.submission.id) }}">
        Download report PDF
      </a>
    </div>
    <div class="govuk-grid-column-three-quarters-from-desktop app-section-content-container">
      {# exception for xl heading where we'd anticipate having many subheadings and levels of heirarchy on this page #}
      <h1 id="submission" class="govuk-heading-xl">{{ page_title }}</h1>

      {% if submission.is_submitted %}
        {# if certification wasn't required then show who submitted directly #}
        {% set submitter = submission.sent_for_certification_by or submission.submitted_by %}
        <dl class="app-metadata">
          <dt class="app-metadata__key">Organisation:</dt>
          <dd class="app-metadata__value" data-testid="submission-status">{{ submission.submission.grant_recipient.organisation.name }}</dd>
        </dl>
        <dl class="app-metadata">
          <dt class="app-metadata__key">Submitted by:</dt>
          <dd class="app-metadata__value" data-testid="submission-status">{{ submitter.name }}</dd>
        </dl>
        {% if submission.certified_by %}
          <dl class="app-metadata">
            <dt class="app-metadata__key">Certifier:</dt>
            <dd class="app-metadata__value" data-testid="submission-status">{{ submission.certified_by.name }}</dd>
          </dl>
        {% endif %}
        <dl class="app-metadata govuk-!-margin-bottom-9">
          <dt class="app-metadata__key">Date submitted:</dt>
          <dd class="app-metadata__value" data-testid="submission-status">{{ format_date(submission.submitted_at_utc) }}</dd>
        </dl>
      {% elif submission.is_awaiting_sign_off %}
        <dl class="app-metadata">
          <dt class="app-metadata__key">Submission deadline:</dt>
          <dd class="app-metadata__value" data-testid="submission-status">{{ format_date(submission.collection.submission_period_end_date) if submission.collection.submission_period_end_date else "Dates to be confirmed" }}</dd>
        </dl>
        <dl class="app-metadata">
          <dt class="app-metadata__key">Submitted by:</dt>
          <dd class="app-metadata__value" data-testid="submission-status">{{ submission.sent_for_certification_by.name }}</dd>
        </dl>
        <dl class="app-metadata">
          <dt class="app-metadata__key">Date submitted for sign off:</dt>
          <dd class="app-metadata__value" data-testid="submission-status">{{ format_date(submission.sent_for_certification_at_utc) }}</dd>
        </dl>
        <dl class="app-metadata govuk-!-margin-bottom-9">
          <dt class="app-metadata__key">Status:</dt>
          <dd class="app-metadata__value" data-testid="submission-status">{{ submissionStatusTag(submission.status, submission.is_overdue) }}</dd>
        </dl>
      {% endif %}

      {% for form in submission.get_ordered_visible_forms() %}
        <h2 id="form-{{ form.id }}" class="govuk-heading-m govuk-!-margin-top-9">{{ form.title }}</h2>
        {{ answers_summary_list(submission, form) }}
      {% endfor %}

      {% if should_certify %}
        <h2 id="sign-off-and-submit-report" class="govuk-heading-m govuk-!-margin-top-9">Sign off and submit report</h2>
        <p class="govuk-body">
          Sign off and submit the report to the {{ submission.collection.grant.organisation.name }} by
          {{ format_date_short(submission.collection.submission_period_end_date) if submission.collection.submission_period_end_date else "(Dates to be confirmed)" }}.
        </p>

        <p class="govuk-body">If you need to decline the report, provide a reason so {{ submission.sent_for_certification_by.name }} can update and resubmit the report.</p>

        <form method="POST" novalidate>
          <div class="govuk-button-group">
            {{ form.csrf_token }}
            {{ form.submit(params={"text": "Continue to sign off and submit" }) }}
            <a class="govuk-button--secondary govuk-button" href="{{ url_for("access_grant_funding.decline_report", organisation_id=grant_recipient.organisation_id, grant_id=grant_recipient.grant_id, submission_id=submission.id) }}">
              Decline sign off
            </a>
          </div>
        </form>
      {% endif %}
    </div>
  </div>
{% endblock %}
