{% extends "access_grant_funding/base.html" %}
{% from "govuk_frontend_jinja/components/table/macro.html" import govukTable %}
{% from "common/macros/status.html" import submissionStatusTag with context %}
{% from "common/macros/status.html" import submissionStatusAction with context %}

{% set page_title = "Reports" %}
{% set active_item_identifier = "reports" %}
{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h1 class="govuk-heading-l">Reports</h1>
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      {% if reports|length == 0 %}
        <p class="govuk-body">There are no reports for this grant.</p>
      {% else %}
        {% set rows=[] %}
        {% for report in reports %}
          {% set submission = submissions | selectattr("collection_id", "equalto", report.id) | first %}
          {% set submission_status = submission.status if submission else enum.submission_status.NOT_STARTED %}
          {% set submission_status_html %}
            {{ submissionStatusTag(submission_status) }}
          {% endset %}
          {% set report_action_html %}
            <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('access_grant_funding.route_to_submission', organisation_id=grant_recipient.organisation.id, grant_id=grant_recipient.grant.id, collection_id=report.id) }}">
              {{ submissionStatusAction(submission_status) }}<span class="govuk-visually-hidden">for {{ format_date_range_short(report.reporting_period_start_date, report.reporting_period_end_date) }}</span>
            </a>
          {% endset %}
          {# todo: standardise this behaviour everywhere by adding this logic as a property on the model if its signed off #}
          {% set report_label %}
            {% if report.name %}
              {{ report.name }}
            {% else %}
              {{ format_date_range_short(report.reporting_period_start_date, report.reporting_period_end_date) }}
            {% endif %}
          {% endset %}
          {%
            do rows.append([
              {"text": report_label},
              {"text": format_date_short(report.submission_period_end_date)}, {"html": submission_status_html},
              {"html": report_action_html}
            ])
          %}
        {% endfor %}
        {{
          govukTable(params={
                  "firstCellIsHeader": false,
                  "head":[
                    {"text": "Reporting period"},
                    {"text": "Due date"},
                    {"text": "Status"},
                    {}
                  ],
                  "rows":rows
          })
        }}
      {% endif %}
    </div>
  </div>
{% endblock %}
