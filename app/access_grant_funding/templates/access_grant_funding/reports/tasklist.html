{% from "common/macros/status.html" import submissionStatusTag with context %}
{% from "common/macros/collections.html" import collection_tasklist with context %}
{% from "govuk_frontend_jinja/components/back-link/macro.html" import govukBackLink %}
{% extends "access_grant_funding/base.html" %}

{# todo: move the suffix to the base template and call super #}
{% set page_title = runner.submission.name ~ " - " ~ grant_recipient.grant.name %}

{% set form = runner.tasklist_form %}
{% set active_item_identifier = "reports" %}

{% block beforeContent %}
  {{ super() }}
  {{
    govukBackLink({
      "href": url_for("access_grant_funding.list_reports", organisation_id=grant_recipient.organisation.id, grant_id=grant_recipient.grant.id),
      "text": "Back"
    })
  }}
{% endblock beforeContent %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h1 class="govuk-heading-l">{{ runner.submission.name }}</h1>

      <dl class="app-metadata">
        <dt class="app-metadata__key">Submission deadline:</dt>
        <dd class="app-metadata__value" data-testid="submission-status">
          {% if runner.submission.collection.submission_period_end_date %}
            {{ format_date(runner.submission.collection.submission_period_end_date) }}
          {% else %}
            <span>(Dates to be confirmed)</span>
          {% endif %}
        </dd>
      </dl>
      <dl class="app-metadata govuk-!-margin-bottom-7">
        <dt class="app-metadata__key">Status:</dt>
        <dd class="app-metadata__value" data-testid="submission-status">{{ submissionStatusTag(runner.submission.status) }}</dd>
      </dl>
    </div>
  </div>

  {% if runner.submission.collection.requires_certification %}
    {% set before_submission %}
      <h2 class="govuk-heading-m">Submit your report to your certifier</h2>
      <p class="govuk-body">You can submit the report for sign off once it's complete.</p>
      <p class="govuk-body">
        We'll send the report to {{ grant_recipient.certifier_names }}. View who has access to the report and their permissions on the
        <a class="govuk-link" href="{{ url_for('access_grant_funding.list_grant_team', organisation_id=grant_recipient.organisation.id, grant_id=grant_recipient.grant.id) }}">Team page</a>.
      </p>
      <p class="govuk-body">You cannot make changes while your report is awaiting sign off.</p>
    {% endset %}
    {% set submit_text="Submit report to certifier" %}
  {% else %}
    {% set before_submission %}
      <h2 class="govuk-heading-m">Submit your report</h2>
      <p class="govuk-body">You can submit your report to the {{ runner.submission.collection.grant.organisation.name }}.</p>
    {% endset %}
    {% set submit_text="Submit report" %}
  {% endif %}

  {{ collection_tasklist(runner, submit_text, before_submission=before_submission, has_permission_to_edit=authorisation_helper.is_access_grant_data_provider(runner.submission.grant.id, runner.submission.submission.grant_recipient.organisation_id, current_user)) }}
{% endblock content %}
