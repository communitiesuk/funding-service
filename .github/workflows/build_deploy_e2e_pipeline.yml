name: Deployment pipeline
run-name: Build, deploy and e2e test ${{github.ref_name}}

permissions:
  packages: write
  contents: read  # This is required for actions/checkout
  id-token: write  # This is required for authenticating with aws

on:
  push:
    branches:
      - main

jobs:
  paketo_build:
    name: Build
    uses: ./.github/workflows/package.yml
    secrets:
      AWS_ACCOUNT: ${{ secrets.AWS_ACCOUNT }}
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      TEMP_SLACK_CHANNEL_ID: ${{ secrets.TEMP_SLACK_CHANNEL_ID }}

  deploy_dev:
    name: Deploy to dev
    needs:
      - paketo_build
    uses: ./.github/workflows/deploy.yml
    concurrency:
      group: fs-deploy-dev
      cancel-in-progress: false
    with:
      environment: dev
      ghcr_image_location: ${{ needs.paketo_build.outputs.ghcr_image_location }}
      run_e2e_tests: true
    secrets:
      AWS_ACCOUNT: ${{ secrets.AWS_ACCOUNT }}
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      TEMP_SLACK_CHANNEL_ID: ${{ secrets.TEMP_SLACK_CHANNEL_ID }}

  deploy_test:
    name: Deploy to test
    needs:
      - paketo_build
      - deploy_dev
    uses: ./.github/workflows/deploy.yml
    concurrency:
      group: fs-deploy-test
      cancel-in-progress: false
    with:
      environment: test
      ghcr_image_location: ${{ needs.paketo_build.outputs.ghcr_image_location }}
      run_e2e_tests: true
    secrets:
      AWS_ACCOUNT: ${{ secrets.AWS_ACCOUNT }}
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      TEMP_SLACK_CHANNEL_ID: ${{ secrets.TEMP_SLACK_CHANNEL_ID }}
